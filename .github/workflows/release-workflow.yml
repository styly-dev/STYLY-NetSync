name: '_Release workflow'

on:
  workflow_dispatch:
    inputs:
      info:
        description: |
          This workflow will set version for Unity and Python, commit version changes to develop, merge develop into main and create a release draft.
        required: false
        type: boolean
      version:
        description: 'Version number (e.g., 1.0.0 or 1.0.0-beta.1)'
        required: true
        type: string

jobs:
  set-version-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0  # Full history for merge operations
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # Check semantic versioning format (including pre-release versions)
          if ! echo "$VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$' > /dev/null; then
            echo "âŒ Error: Invalid version format: $VERSION"
            echo "Version must follow semantic versioning (e.g., 1.0.0 or 1.0.0-beta.1)"
            exit 1
          fi
          echo "âœ… Version format is valid: $VERSION"

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if develop branch is up to date
        run: |
          git fetch origin develop
          LOCAL_COMMIT=$(git rev-parse HEAD)
          REMOTE_COMMIT=$(git rev-parse origin/develop)
          
          if [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
            echo "âŒ Error: develop branch is not up to date with origin/develop"
            echo "Please pull the latest changes from origin/develop before running this workflow"
            exit 1
          fi
          echo "âœ… develop branch is up to date"

      - name: Update Unity package.json version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PACKAGE_FILE="STYLY-NetSync-Unity/Packages/com.styly.styly-netsync/package.json"
          
          if [ ! -f "$PACKAGE_FILE" ]; then
            echo "âŒ Error: Unity package.json not found at $PACKAGE_FILE"
            exit 1
          fi
          
          # Update version using jq (precise JSON manipulation)
          jq --arg ver "$VERSION" '.version = $ver' "$PACKAGE_FILE" > tmp.json && mv tmp.json "$PACKAGE_FILE"
          
          echo "âœ… Updated Unity package.json version to $VERSION"
          echo "Updated content:"
          cat "$PACKAGE_FILE"

      - name: Update Unity version.txt file
        run: |
          VERSION="${{ github.event.inputs.version }}"
          VERSION_FILE="STYLY-NetSync-Unity/Packages/com.styly.styly-netsync/Runtime/Resources/com.styly.styly-netsync.version.txt"
          
          if [ ! -f "$VERSION_FILE" ]; then
            echo "âŒ Error: Unity version.txt not found at $VERSION_FILE"
            exit 1
          fi
          
          # Update version.txt file
          echo "$VERSION" > "$VERSION_FILE"
          
          echo "âœ… Updated Unity version.txt file to $VERSION"
          echo "Updated content:"
          cat "$VERSION_FILE"

      - name: Update Python pyproject.toml version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PYPROJECT_FILE="STYLY-NetSync-Server/pyproject.toml"
          
          if [ ! -f "$PYPROJECT_FILE" ]; then
            echo "âŒ Error: Python pyproject.toml not found at $PYPROJECT_FILE"
            exit 1
          fi
          
          # Update version line in pyproject.toml
          sed -i "s/^version = .*/version = \"$VERSION\"/" "$PYPROJECT_FILE"
          
          echo "âœ… Updated Python pyproject.toml version to $VERSION"
          echo "Updated version line:"
          grep "^version = " "$PYPROJECT_FILE"

      - name: Update version in .md files
        run: |
          VERSION="${{ github.event.inputs.version }}"

          echo "ðŸ“ Updating version numbers in .md files..."

          # Find all .md files in the repository
          MD_FILES=$(find . -name "*.md" -type f)

          UPDATED_COUNT=0
          for file in $MD_FILES; do
            # Skip if file doesn't exist (defensive check)
            [ ! -f "$file" ] && continue

            # Update styly-netsync-server@X.X.X pattern
            if grep -q "styly-netsync-server@[0-9]\+\.[0-9]\+\.[0-9]\+" "$file"; then
              sed -i "s/styly-netsync-server@[0-9]\+\.[0-9]\+\.[0-9]\+/styly-netsync-server@$VERSION/g" "$file"
              echo "  âœ… Updated styly-netsync-server version in $file"
              UPDATED_COUNT=$((UPDATED_COUNT + 1))
            fi

            # Update com.styly.styly-netsync@X.X.X pattern
            if grep -q "com\.styly\.styly-netsync@[0-9]\+\.[0-9]\+\.[0-9]\+" "$file"; then
              sed -i "s/com\.styly\.styly-netsync@[0-9]\+\.[0-9]\+\.[0-9]\+/com.styly.styly-netsync@$VERSION/g" "$file"
              echo "  âœ… Updated com.styly.styly-netsync version in $file"
              UPDATED_COUNT=$((UPDATED_COUNT + 1))
            fi
          done

          if [ $UPDATED_COUNT -eq 0 ]; then
            echo "â„¹ï¸ No version strings found in .md files (this is normal if none exist yet)"
          else
            echo "âœ… Updated version in $UPDATED_COUNT location(s)"
          fi

      - name: Commit version changes
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Add all version files
          git add STYLY-NetSync-Unity/Packages/com.styly.styly-netsync/package.json
          git add STYLY-NetSync-Unity/Packages/com.styly.styly-netsync/Runtime/Resources/com.styly.styly-netsync.version.txt
          git add STYLY-NetSync-Server/pyproject.toml

          # Add any modified .md files
          git add "*.md"

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "âš ï¸ Warning: No changes to commit. Versions may already be set to $VERSION"
            exit 0
          fi
          
          # Commit changes
          git commit -m "chore: bump version to $VERSION

          - Updated Unity package version in package.json
          - Updated Unity version.txt file for runtime version retrieval
          - Updated Python server version in pyproject.toml
          - Updated version references in .md files (if any)"

          echo "âœ… Committed version changes"

      - name: Push to develop branch
        run: |
          git push origin develop
          echo "âœ… Pushed changes to develop branch"

      - name: Merge develop into main
        run: |
          # Fetch all remote branches to ensure latest refs
          git fetch origin
          
          # Checkout main branch
          git checkout main
          
          # Fast-forward merge origin/develop into main
          git merge --ff-only origin/develop
          
          echo "âœ… Successfully fast-forward merged origin/develop into main"

      - name: Push main branch
        run: |
          git push origin main
          echo "âœ… Pushed changes to main branch"

      - name: Create Release Draft
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG_NAME="v$VERSION"
          
          echo "Creating release draft for $TAG_NAME..."
          
          # Create release draft using GitHub CLI
          gh release create "$TAG_NAME" \
            --draft \
            --target main \
            --title "$TAG_NAME" \
            --notes "## What's Changed
          
          
          ---
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/previous-tag...$TAG_NAME"
          
          echo "âœ… Release draft created: $TAG_NAME"
          echo "ðŸ“ Please edit the release notes at: https://github.com/${{ github.repository }}/releases"

      - name: Summary
        if: always()
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG_NAME="v$VERSION"
          
          # Write to GitHub Step Summary
          {
            echo "# ðŸ“¦ Version Release Workflow Summary"
            echo ""
            
            if [ "${{ job.status }}" == "success" ]; then
              echo "## âœ… Status: Success"
              echo ""
              echo "### ðŸŽ¯ Completed Actions"
              echo ""
              echo "| Step | Status | Description |"
              echo "|------|--------|-------------|"
              echo "| Version Update | âœ… | Updated Unity package.json to \`$VERSION\` |"
              echo "| Version Update | âœ… | Updated Unity version.txt to \`$VERSION\` |"
              echo "| Version Update | âœ… | Updated Python pyproject.toml to \`$VERSION\` |"
              echo "| Git Commit | âœ… | Committed changes to develop branch |"
              echo "| Branch Merge | âœ… | Fast-forward merged develop â†’ main |"
              echo "| Release Draft | âœ… | Created draft release with tag \`$TAG_NAME\` |"
              echo ""
              echo "### ðŸ“¦ Updated Files"
              echo ""
              echo "- \`STYLY-NetSync-Unity/Packages/com.styly.styly-netsync/package.json\`"
              echo "- \`STYLY-NetSync-Unity/Packages/com.styly.styly-netsync/Runtime/Resources/com.styly.styly-netsync.version.txt\`"
              echo "- \`STYLY-NetSync-Server/pyproject.toml\`"
              echo ""
              echo "### ðŸš€ Next Steps"
              echo ""
              echo "**Review Release Draft**"
              echo "   - [Edit Release Draft](https://github.com/${{ github.repository }}/releases)"
            else
              echo "## âŒ Status: Failed"
              echo ""
              echo "### ðŸ” Troubleshooting"
              echo ""
              echo "Please check the workflow logs above for detailed error messages."
              echo ""
              echo "#### Common Issues:"
              echo "- **Version format invalid**: Ensure version follows semantic versioning (x.x.x)"
              echo "- **Branch not up to date**: Pull latest changes from origin/develop"
              echo "- **Merge conflict**: Main branch has diverged from develop"
              echo "- **Permission denied**: Check GitHub token permissions"
              echo ""
              echo "### ðŸ”§ Recovery Steps"
              echo ""
              echo "1. Fix the issue based on error messages"
              echo "2. Ensure develop branch is up to date"
              echo "3. Re-run this workflow"
              echo ""
              echo "If issues persist, manually check:"
              echo "- Current versions in both projects"
              echo "- Git branch status"
              echo "- GitHub Actions permissions"
            fi
            
            echo ""
            echo "---"
            echo "*Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"
          } >> $GITHUB_STEP_SUMMARY
